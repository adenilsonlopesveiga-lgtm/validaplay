<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Miss√µes - ValidaPlay</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

h1{
  color:#38bdf8;
  margin:0;
}

button{
  background:#ef4444;
  border:none;
  padding:10px 15px;
  border-radius:6px;
  color:white;
  cursor:pointer;
  font-weight:bold;
}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
}

.card.atrasado{
  border:1px solid #ef4444;
  box-shadow:0 0 10px rgba(239,68,68,0.4);
}

.info{
  color:#cbd5e1;
  margin-top:5px;
}

select{
  padding:8px;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="header">
  <h1>Controle de Miss√µes</h1>
  <button id="btnLogout">Sair</button>
</div>

<div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;">
  <select id="filtroApp">
    <option value="todos">Todos os Apps</option>
  </select>

  <select id="filtroStatus">
    <option value="todos">Todos Status</option>
    <option value="concluida">Conclu√≠das</option>
    <option value="atrasado">Atrasadas</option>
    <option value="hoje">Confirmou Hoje</option>
    <option value="nunca">Nunca Confirmou</option>
  </select>
</div>

<div id="dashboard" style="
  display:flex;
  gap:20px;
  margin-bottom:25px;
  flex-wrap:wrap;
"></div>

<div id="listaMissoes">
Carregando...
</div>

<script type="module">

  

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc,
  updateDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBp43RboeJ5eQildnFcTc7JtkHa0xvQdnM",
  authDomain: "validaplay.firebaseapp.com",
  projectId: "validaplay",
  storageBucket: "validaplay.firebasestorage.app",
  messagingSenderId: "731420070879",
  appId: "1:731420070879:web:2b7a466b362211d8256a6a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

document.getElementById("btnLogout").addEventListener("click", async ()=>{
  await signOut(auth);
  window.location.href = "login.html";
});

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const userRef = doc(db, "usuarios", user.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    alert("Usu√°rio n√£o encontrado.");
    window.location.href = "login.html";
    return;
  }

  const dados = userSnap.data();

  // ‚úÖ ADMIN entra direto
  if (dados.tipo === "admin") {
    carregarMissoes();
    return;
  }

  // üëá SE FOR TESTADOR
  const testadorRef = doc(db, "testadores", user.uid);
  const testadorSnap = await getDoc(testadorRef);

  if (!testadorSnap.exists() || testadorSnap.data().status !== "aprovado") {
    document.body.innerHTML = `
      <h2 style="color:red;">Perfil em an√°lise</h2>
      <p>Seu perfil ainda n√£o foi aprovado.</p>
    `;
    return;
  }

  carregarMissoes();
});
async function carregarMissoes(){

  const lista = document.getElementById("listaMissoes");
  const filtroApp = document.getElementById("filtroApp").value;
  const filtroStatus = document.getElementById("filtroStatus").value;

  lista.innerHTML = "";

  const snap = await getDocs(collection(db,"missoes"));

  if(snap.empty){
    lista.innerHTML = "Nenhuma miss√£o encontrada.";
    return;
  }

  const appsUnicos = new Set();
  const missoesProcessadas = [];

  let totalMissoes = 0;
  let totalConcluidas = 0;
  let totalAndamento = 0;
  let totalAtrasadas = 0;

 for (const docSnap of snap.docs){

  const m = docSnap.data();
  const id = docSnap.id;

  let estaAtrasada = false;

  if(m.status === "em_andamento" && m.dataInicio){

    const inicio = m.dataInicio.toDate 
      ? m.dataInicio.toDate() 
      : new Date(m.dataInicio);

    const hojeCalc = new Date();

    const diasPassados = Math.floor(
      (hojeCalc - inicio) / (1000*60*60*24)
    ) + 1;

    if(diasPassados > m.diaAtual){
      estaAtrasada = true;
    }
  }

  // üî• CORRE√á√ÉO AQUI
  const solicitacaoId = m.appId || m.solicitacaoId;

  const appSnap = solicitacaoId
    ? await getDoc(doc(db,"solicitacoes", solicitacaoId))
    : null;

  const nomeApp = appSnap && appSnap.exists()
    ? appSnap.data().nomeApp
    : "App n√£o encontrado";

  const testadorSnap = await getDoc(doc(db,"testadores", m.testadorId));
  const nomeTestador = testadorSnap.exists()
    ? testadorSnap.data().nome
    : "Testador n√£o encontrado";

  const diaRef = doc(db,"missoes",id,"dias",String(m.diaAtual));
  const diaSnap = await getDoc(diaRef);
  const diaData = diaSnap.exists() ? diaSnap.data() : null;

  let statusTexto = "";
  let botoes = "";

  if(diaData){

    if(diaData.status === "pendente"){
      statusTexto = "Aguardando envio do testador";
    }

    if(diaData.status === "enviado"){
      statusTexto = "Print enviado - aguardando valida√ß√£o";

      botoes = `
        <button style="background:#22c55e"
          onclick="aprovarDia('${id}', ${m.diaAtual})">
          Aprovar Dia
        </button>

        <button style="background:#ef4444"
          onclick="reprovarDia('${id}', ${m.diaAtual})">
          Reprovar Dia
        </button>

        <button style="background:#f59e0b;margin-left:6px;"
          onclick="substituirTestador('${id}')">
          Substituir Testador
        </button>
      `;
    }

    if(diaData.status === "aprovado"){
      statusTexto = "Dia aprovado";
    }

    if(diaData.status === "reprovado"){
      statusTexto = "Reprovado - aguardando novo envio";
    }
  }

  const div = document.createElement("div");
  div.className = "card";

  if(estaAtrasada){
    div.classList.add("atrasado");
  }

  div.innerHTML = `
    <div class="info"><strong>App:</strong> ${nomeApp}</div>
    <div class="info"><strong>Testador:</strong> ${nomeTestador}</div>
    <div class="info">Dia Atual: ${m.diaAtual} / ${m.totalDias}</div>

    ${estaAtrasada ? `
      <div style="color:#ef4444;font-weight:bold;margin-top:8px;">
        ‚ö† Miss√£o em atraso
      </div>
    ` : ''}

    <div style="margin-top:6px;font-weight:bold;">
      ${statusTexto}
    </div>

    ${botoes}
  `;

  lista.appendChild(div);
}

  document.getElementById("dashboard").innerHTML = `
    <div class="card"><strong>Total:</strong> ${totalMissoes}</div>
    <div class="card"><strong>Conclu√≠das:</strong> ${totalConcluidas}</div>
    <div class="card"><strong>Em andamento:</strong> ${totalAndamento}</div>
    <div class="card"><strong>Atrasadas:</strong> ${totalAtrasadas}</div>
  `;
}

document.getElementById("filtroApp").addEventListener("change", carregarMissoes);
document.getElementById("filtroStatus").addEventListener("change", carregarMissoes);


async function aprovarDia(missaoId, diaNumero){

  const diaRef = doc(db,"missoes",missaoId,"dias",String(diaNumero));
  const missaoRef = doc(db,"missoes",missaoId);

  await updateDoc(diaRef,{
    status:"aprovado",
    dataValidacao: new Date()
  });

  await updateDoc(missaoRef,{
    diaAtual: diaNumero + 1
  });

  alert("Dia aprovado com sucesso!");
  carregarMissoes();
}
window.aprovarDia = aprovarDia;


async function reprovarDia(missaoId, diaNumero){

  const diaRef = doc(db,"missoes",missaoId,"dias",String(diaNumero));

  await updateDoc(diaRef,{
    status:"reprovado",
    dataValidacao: new Date()
  });

  alert("Dia reprovado.");
  carregarMissoes();
}
window.reprovarDia = reprovarDia;

async function substituirTestador(missaoId){

  const confirmar = confirm("Deseja substituir este testador?");
  if(!confirmar) return;

  try{

    const missaoRef = doc(db,"missoes",missaoId);
    const missaoSnap = await getDoc(missaoRef);

    if(!missaoSnap.exists()){
      alert("Miss√£o n√£o encontrada.");
      return;
    }

    const missao = missaoSnap.data();

    // üîí Marcar miss√£o antiga como substitu√≠da
    await updateDoc(missaoRef,{
      status:"substituida",
      substituidaEm: new Date()
    });

    // üîé Buscar testadores aprovados
    const testadoresSnap = await getDocs(collection(db,"testadores"));

    const aprovados = testadoresSnap.docs.filter(t =>
      t.data().status === "aprovado" &&
      t.id !== missao.testadorId
    );

    if(aprovados.length === 0){
      alert("Nenhum testador dispon√≠vel.");
      return;
    }

    // üéØ Escolher o primeiro dispon√≠vel
    const novoTestador = aprovados[0];

    // üöÄ Criar nova miss√£o
    const novaMissaoRef = await addDoc(collection(db,"missoes"),{
      appId: missao.appId,
      testadorId: novoTestador.id,
      status: "em_andamento",
      diaAtual: 1,
      totalDias: 14,
      dataInicio: new Date(),
      dataFim: new Date(Date.now() + 14*24*60*60*1000),
      criadoEm: new Date(),
      substituiuMissaoId: missaoId
    });

    // üî• Criar 14 dias
    for(let i=1;i<=14;i++){
      await addDoc(collection(db,"missoes",novaMissaoRef.id,"dias"),{
        numero: i,
        status:"pendente",
        printUrl:"",
        dataEnvio:null,
        dataValidacao:null
      });
    }

    alert("Testador substitu√≠do com sucesso!");
    carregarMissoes();

  }catch(error){
    console.error(error);
    alert("Erro ao substituir testador.");
  }
}
window.substituirTestador = substituirTestador;
</script>

</body>
</html>