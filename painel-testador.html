<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel do Testador - ValidaPlay</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}

h1{
  color:#38bdf8;
  margin-bottom:20px;
}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
}

.info{
  color:#cbd5e1;
  margin-top:5px;
}

.destaque{
  color:#22c55e;
  font-weight:bold;
}

button{
  margin-top:15px;
  padding:8px 12px;
  border:none;
  border-radius:6px;
  color:white;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<div style="display:flex; justify-content:space-between; align-items:center;">
  <h1 style="margin:0;">Minhas Missões</h1>
  <button id="btnLogout" style="background:#ef4444;">Sair</button>
</div>

<div style="margin-bottom:20px;"></div>

<div id="listaMissoes">
Carregando...
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL,
  deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "validaplay.firebaseapp.com",
  projectId: "validaplay",
  storageBucket: "validaplay.firebasestorage.app",
  messagingSenderId: "731420070879",
  appId: "1:731420070879:web:2b7a466b362211d8256a6a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);


async function carregarMinhasMissoes(user){

  const lista = document.getElementById("listaMissoes");
  lista.innerHTML = "";

  const q = query(
    collection(db,"missoes"),
    where("testadorId","==", user.uid)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    lista.innerHTML = "Nenhuma missão ativa.";
    return;
  }

  for(const docSnap of snap.docs){

    const m = docSnap.data();
    const missaoId = docSnap.id;

    const diaRef = doc(db,"missoes",missaoId,"dias",String(m.diaAtual));
    const diaSnap = await getDoc(diaRef);

    if(!diaSnap.exists()) continue;

    const diaData = diaSnap.data();

    const div = document.createElement("div");
    div.className = "card";

    let statusTexto = "";
    let botaoHtml = "";

    if(diaData.status === "pendente"){
      statusTexto = "Aguardando envio";
      botaoHtml = `
        <button style="background:#22c55e"
          onclick="enviarPrint('${missaoId}', ${m.diaAtual})">
          Enviar print do dia ${m.diaAtual}
        </button>
      `;
    }
    else if(diaData.status === "enviado"){
      statusTexto = "Print enviado. Aguardando aprovação do administrador.";
      botaoHtml = `
        <button disabled style="background:#64748b">
          Print já enviado
        </button>
      `;
    }
    else if(diaData.status === "reprovado"){
      statusTexto = "Reprovado. Envie novamente.";
      botaoHtml = `
        <button style="background:#ef4444"
          onclick="reenviarPrint('${missaoId}', ${m.diaAtual}, '${diaData.printUrl || ""}')">
          Reenviar print
        </button>
      `;
    }
    else if(diaData.status === "aprovado"){
      statusTexto = "Dia aprovado pelo administrador.";
    }

    div.innerHTML = `
      <div class="info"><strong>App:</strong> ${m.nomeApp}</div>
      <div class="info">Dia Atual: ${m.diaAtual} / ${m.totalDias}</div>
      <div class="info destaque">Status do Dia: ${statusTexto}</div>
      ${botaoHtml}
    `;

    lista.appendChild(div);
  }
}


// ==========================
// ENVIO DE PRINT
// ==========================
window.enviarPrint = async function(missaoId, diaAtual){

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";

  input.onchange = async (e)=>{

    const file = e.target.files[0];
    if(!file) return;

    const storageRef = ref(storage, `prints/${missaoId}/dia_${diaAtual}.jpg`);

    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    const diaRef = doc(db,"missoes",missaoId,"dias",String(diaAtual));

    await updateDoc(diaRef,{
      printUrl: url,
      status: "enviado",
      dataEnvio: serverTimestamp()
    });

    alert("Print enviado com sucesso!");
    location.reload();
  };

  input.click();
};


// ==========================
// REENVIO SE REPROVADO
// ==========================
window.reenviarPrint = async function(missaoId, diaAtual, antigaUrl){

  if(antigaUrl){
    try{
      const oldRef = ref(storage, antigaUrl);
      await deleteObject(oldRef);
    }catch(e){}
  }

  await enviarPrint(missaoId, diaAtual);
};


onAuthStateChanged(auth, (user)=>{
  if(!user){
    window.location.href = "login-testador.html";
    return;
  }
  carregarMinhasMissoes(user);
});

document.getElementById("btnLogout").addEventListener("click", async ()=>{
  await signOut(auth);
  window.location.href = "login-testador.html";
});

</script>
</body>
</html>