<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Admin - ValidaPlay</title>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#0f172a;
    color:white;
}

header{
    background:#020617;
    padding:20px;
    text-align:center;
    border-bottom:1px solid #1e293b;
}

h1{
    color:#38bdf8;
}

.main{
    display:flex;
    gap:20px;
    padding:20px;
}

.coluna{
    flex:1;
    min-width:300px;
}

.tituloColuna{
    font-size:22px;
    margin-bottom:15px;
    color:#38bdf8;
    border-bottom:1px solid #1e293b;
    padding-bottom:10px;
}

.card{
    background:#020617;
    border:1px solid #1e293b;
    border-radius:10px;
    padding:15px;
    margin-bottom:15px;
}

.nome{
    font-size:18px;
    color:#38bdf8;
    font-weight:bold;
}

.info{
    color:#cbd5e1;
    margin-top:4px;
}

button{
    margin-top:10px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    color:white;
    cursor:pointer;
    margin-right:5px;
}

.btn-danger{ background:#ef4444; }
.btn-success{ background:#22c55e; }
.btn-warning{ background:#f59e0b; }
.btn-secondary{ background:#64748b; }

.status-aprovado{ color:#22c55e; }
.status-pendente{ color:#f59e0b; }
.status-rejeitado{ color:#64748b; }
.status-bloqueado{ color:#ef4444; }
</style>
</head>

<body>

<header>
  <h1>Painel Administrativo - ValidaPlay</h1>

  <button onclick="logout()" style="
    background:#ef4444;
    padding:10px 15px;
    border-radius:6px;
    color:white;
    border:none;
    cursor:pointer;
    font-weight:bold;
  ">
    ðŸšª Sair
  </button>

  <div style="margin-top:15px;">
    <a href="missoes.html" style="
      background:#38bdf8;
      padding:10px 15px;
      border-radius:6px;
      color:#020617;
      text-decoration:none;
      font-weight:bold;
    ">
      Controle de MissÃµes
    </a>
  </div>
</header>

<div class="main">

<div class="coluna">
    <div class="tituloColuna">SolicitaÃ§Ãµes de Empresas</div>
    <div id="listaSolicitacoes">Carregando...</div>
</div>

<div class="coluna">
    <div class="tituloColuna">Testadores Cadastrados</div>
    <div id="listaTestadores">Carregando...</div>
</div>

</div>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  getDoc,
  query, 
  orderBy,
  where,
  doc,
  updateDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { getFunctions, httpsCallable } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBp43RboeJ5eQildnFcTc7JtkHa0xvQdnM",
  authDomain: "validaplay.firebaseapp.com",
  projectId: "validaplay",
  storageBucket: "validaplay.firebasestorage.app",
  messagingSenderId: "731420070879",
  appId: "1:731420070879:web:2b7a466b362211d8256a6a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const functions = getFunctions(app);

/* ðŸ” PROTEÃ‡ÃƒO ADMIN */
onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const userSnap = await getDoc(doc(db, "usuarios", user.uid));

  if (!userSnap.exists() || userSnap.data().tipo !== "admin") {
    alert("Acesso restrito ao administrador.");
    await auth.signOut();
    window.location.href = "login.html";
    return;
  }

  carregarSolicitacoes();
  carregarTestadores();
});

/* ðŸ”¥ EXCLUIR */
async function excluirRegistro(colecao, id){

  if(!confirm("Excluir definitivamente?")) return;

  try{

    const excluirUsuario = httpsCallable(functions, "excluirUsuarioCompleto");

    await excluirUsuario({
      uid: id,
      colecao: colecao
    });

    alert("ExcluÃ­do com sucesso.");

    if(colecao === "solicitacoes"){
      carregarSolicitacoes();
    } else {
      carregarTestadores();
    }

  } catch(error){
    alert("Erro ao excluir: " + error.message);
  }
}

/* ðŸ”„ ATUALIZAR STATUS */
async function atualizarStatus(colecao, id, novoStatus){

  await updateDoc(doc(db, colecao, id), {
    status: novoStatus
  });

  if(colecao === "solicitacoes"){
    carregarSolicitacoes();
  } else {
    carregarTestadores();
  }
}

window.excluirRegistro = excluirRegistro;
window.atualizarStatus = atualizarStatus;

window.logout = async function(){
  await auth.signOut();
  window.location.href = "login.html";
};

/* ðŸ”µ SOLICITAÃ‡Ã•ES */
async function carregarSolicitacoes(){

  const lista = document.getElementById("listaSolicitacoes");
  lista.innerHTML = "";

  const snap = await getDocs(
    query(collection(db,"solicitacoes"), orderBy("criadoEm","desc"))
  );

  snap.forEach(docSnap=>{

    const s = docSnap.data();
    const id = docSnap.id;

    if (s.arquivado === true) return;

    const status = s.status || "pendente";

    const div = document.createElement("div");
    div.className="card";

    div.innerHTML = `
      <div class="nome">${s.nomeApp}</div>
      <div class="info">Email: ${s.email || "-"}</div>
      <div class="info">Quantidade: ${s.quantidade || "-"}</div>
      <div class="info">
        Status:
        <strong class="status-${status}">
          ${status}
        </strong>
      </div>

      <div style="margin-top:10px;">

        ${(status === "pendente" || status === "novo") ? `
          <button class="btn-success"
            onclick="atualizarStatus('solicitacoes','${id}','aprovado')">
            Aprovar
          </button>

          <button class="btn-secondary"
            onclick="atualizarStatus('solicitacoes','${id}','rejeitado')">
            Rejeitar
          </button>
        ` : ''}

        ${status === "aprovado" && !s.missoesCriadas ? `
          <button class="btn-success"
            onclick="criarMissoes('${id}')">
            Criar MissÃµes
          </button>
        ` : ''}

        <button class="btn-secondary"
          onclick="verDetalhes('${id}')">
          Detalhes
        </button>

        <button class="btn-danger"
          onclick="excluirRegistro('solicitacoes','${id}')">
          Excluir
        </button>

      </div>
    `;

    lista.appendChild(div);
  });
}
/* ðŸŸ¢ TESTADORES */
async function carregarTestadores(){

  const lista = document.getElementById("listaTestadores");
  lista.innerHTML = "";

  const snap = await getDocs(
    query(collection(db,"testadores"), orderBy("criadoEm","desc"))
  );

  if(snap.empty){
    lista.innerHTML = "Nenhum testador cadastrado.";
    return;
  }

  snap.forEach(docSnap=>{

    const t = docSnap.data();
    const id = docSnap.id;
    const status = t.status || "pendente";

    const div = document.createElement("div");
    div.className="card";

    div.innerHTML = `
      <div class="nome">${t.nome || "Sem nome"}</div>
      <div class="info">Email: ${t.email || "-"}</div>
      <div class="info">WhatsApp: ${t.whatsapp || "-"}</div>
      <div class="info">Modelo: ${t.modelo || "-"}</div>

      <div class="info">
        Status:
        <strong class="status-${status}">
          ${status}
        </strong>
      </div>

      <div style="margin-top:10px;">

        ${status === "pendente" ? `
          <button class="btn-success"
            onclick="atualizarStatus('testadores','${id}','aprovado')">
            Aprovar
          </button>

          <button class="btn-secondary"
            onclick="atualizarStatus('testadores','${id}','rejeitado')">
            Rejeitar
          </button>
        ` : ''}

        ${status === "aprovado" ? `
          <button class="btn-warning"
            onclick="atualizarStatus('testadores','${id}','bloqueado')">
            Bloquear
          </button>
        ` : ''}

        ${status === "bloqueado" ? `
          <button class="btn-success"
            onclick="atualizarStatus('testadores','${id}','aprovado')">
            Reativar
          </button>
        ` : ''}

        <button class="btn-danger"
          onclick="excluirRegistro('testadores','${id}')">
          Excluir
        </button>

      </div>
    `;

    lista.appendChild(div);
  });
}

/* ðŸš€ CRIAR MISSÃ•ES */
async function criarMissoes(appId){

  try {

    const criar = httpsCallable(functions, "criarMissoesManual");

    await criar({ solicitacaoId: appId });

    alert("MissÃµes criadas com sucesso!");
    carregarSolicitacoes();

  } catch(error){
    alert("Erro ao criar missÃµes: " + error.message);
  }
}

window.criarMissoes = criarMissoes;

window.verDetalhes = function(id){
  window.location.href = "admin-detalhes.html?id=" + id;
};

</script>

</body>
</html>