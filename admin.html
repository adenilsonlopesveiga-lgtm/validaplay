<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Admin - ValidaPlay</title>



<style>
body{
    margin:0;
    font-family:Arial;
    background:#0f172a;
    color:white;
}

header{
    background:#020617;
    padding:20px;
    text-align:center;
    border-bottom:1px solid #1e293b;
}

h1{
    color:#38bdf8;
}

.main{
    display:flex;
    gap:20px;
    padding:20px;
}

.coluna{
    flex:1;
    min-width:300px;
}

.tituloColuna{
    font-size:22px;
    margin-bottom:15px;
    color:#38bdf8;
    border-bottom:1px solid #1e293b;
    padding-bottom:10px;
}

.card{
    background:#020617;
    border:1px solid #1e293b;
    border-radius:10px;
    padding:15px;
    margin-bottom:15px;
}

.nome{
    font-size:18px;
    color:#38bdf8;
    font-weight:bold;
}

.info{
    color:#cbd5e1;
    margin-top:4px;
}

pre{
    white-space: pre-wrap;
    background:#0f172a;
    padding:10px;
    border-radius:6px;
    color:#38bdf8;
    margin-top:5px;
    font-size:13px;
}

button{
    margin-top:10px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    color:white;
    cursor:pointer;
    margin-right:5px;
}
.btn-historico{
    background:#0ea5e9;
    color:white;
    padding:10px 15px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
}

.btn-historico:hover{
    background:#0284c7;
}

.btn-danger{ background:#ef4444; }
.btn-success{ background:#22c55e; }
.btn-warning{ background:#f59e0b; }
.btn-secondary{ background:#64748b; }

.status-aprovado{ color:#22c55e; }
.status-em_validacao { color:#38bdf8; }
.status-bloqueado{ color:#ef4444; }
.status-pendente{ color:#f59e0b; }
.status-rejeitado{ color:#64748b; }

</style>
</head>


</div>

<body>

<header>
  <h1>Painel Administrativo - ValidaPlay</h1>

  <div style="margin-top:15px;">
    <a href="missoes.html" style="
      background:#38bdf8;
      padding:10px 15px;
      border-radius:6px;
      color:#020617;
      text-decoration:none;
      font-weight:bold;
    ">
      Controle de MissÃµes
    </a>

    <button class="btn-historico"
      onclick="window.location.href='admin-historico.html'"
      style="margin-left:10px;">
      ðŸ“‚ HistÃ³rico de Apps
    </button>

  </div>
</header>


<div class="main">

<div class="coluna">
    <div class="tituloColuna">SolicitaÃ§Ãµes de Empresas</div>
    <div id="listaSolicitacoes">Carregando...</div>
</div>

<div class="coluna">
    <div class="tituloColuna">Testadores Cadastrados</div>
    <div id="listaTestadores">Carregando...</div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  getDoc,
  query, 
  orderBy,
  where,  
  deleteDoc,
  doc,
  updateDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";




import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


const firebaseConfig = {
  apiKey: "AIzaSyBp43RboeJ5eQildnFcTc7JtkHa0xvQdnM",
  authDomain: "validaplay.firebaseapp.com",
  projectId: "validaplay",
  storageBucket: "validaplay.firebasestorage.app",
  messagingSenderId: "731420070879",
  appId: "1:731420070879:web:2b7a466b362211d8256a6a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ðŸ” PROTEÃ‡ÃƒO */
onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      alert("UsuÃ¡rio nÃ£o encontrado na base.");
      await auth.signOut();
      window.location.href = "login.html";
      return;
    }

    const dados = userSnap.data();

    if (dados.tipo !== "admin") {
      alert("Acesso restrito ao administrador.");
      await auth.signOut();
      window.location.href = "login.html";
      return;
    }

    // âœ… Se chegou aqui, Ã© admin verdadeiro
    carregarSolicitacoes();
    carregarTestadores();

  } catch (error) {
    console.error("Erro ao validar admin:", error);
    alert("Erro interno de validaÃ§Ã£o.");
    await auth.signOut();
    window.location.href = "login.html";
  }

});


/* ðŸ”¥ EXCLUIR */
async function excluirRegistro(colecao, id){
  const confirmar = confirm("Tem certeza que deseja excluir?");
  if(!confirmar) return;

  await deleteDoc(doc(db, colecao, id));

  if(colecao === "solicitacoes"){
    carregarSolicitacoes();
  } else {
    carregarTestadores();
  }
}

/* ðŸ”„ ATUALIZAR STATUS */
async function atualizarStatus(colecao, id, novoStatus){
  await updateDoc(doc(db, colecao, id), {
    status: novoStatus
  });

  if(colecao === "solicitacoes"){
    carregarSolicitacoes();
  } else {
    carregarTestadores();
  }
}

window.excluirRegistro = excluirRegistro;
window.atualizarStatus = atualizarStatus;

/* ðŸ”µ EMPRESAS */
async function carregarSolicitacoes(){
    const lista = document.getElementById("listaSolicitacoes");
    lista.innerHTML = "";

   const q = query(
  collection(db,"solicitacoes"),
  orderBy("criadoEm","desc")
);

const snap = await getDocs(q);

snap.forEach(docSnap=>{
    const s = docSnap.data();
    const id = docSnap.id;

    // ðŸ”¥ NÃƒO MOSTRAR ARQUIVADOS
    if (s.arquivado === true) return;

    const status = s.status || "pendente";

    const div = document.createElement("div");
    div.className="card";

   div.innerHTML = `
  <div class="nome">${s.nomeApp}</div>

  <div class="info">Email: ${s.email || "-"}</div>
  <div class="info">Quantidade: ${s.quantidade || "-"}</div>
  <div class="info">
    Status:
    <strong class="status-${status}">
      ${status}
    </strong>
  </div>

  <div style="margin-top:10px;">

    ${!s.missoesCriadas ? `
      <button class="btn-success" onclick="criarMissoes('${id}')">
        Criar MissÃµes
      </button>
    ` : ''}

    <button class="btn-secondary"
      onclick="verDetalhes('${id}')">
      Detalhes
    </button>

    <button class="btn-danger"
      onclick="excluirRegistro('solicitacoes','${id}')">
      Excluir
    </button>

  </div>
`;

    lista.appendChild(div);
});
}

/* ðŸŸ¢ TESTADORES */
async function carregarTestadores(){
    const lista = document.getElementById("listaTestadores");
    lista.innerHTML = "";

    const q = query(
      collection(db,"testadores"),
      orderBy("criadoEm","desc")
    );

    const snap = await getDocs(q);

    if(snap.empty){
        lista.innerHTML = "Nenhum testador cadastrado.";
        return;
    }

    snap.forEach(docSnap=>{
        const t = docSnap.data();
        const id = docSnap.id;
        const status = ["pendente","aprovado","bloqueado","rejeitado"]
  .includes(t.status) ? t.status : "pendente";


        const div = document.createElement("div");
        div.className="card";

        div.innerHTML=`
<div class="nome">${t.nome || "Sem nome"}</div>
<div class="info">Email: ${t.email || "-"}</div>


<div class="info">
WhatsApp:
<a target="_blank"
href="https://wa.me/55${(t.whatsapp || '').replace(/\D/g,'')}?text=${encodeURIComponent(
`OlÃ¡ ${t.nome || ""}!

Seu cadastro foi aprovado na ValidaPlay ðŸŽ‰

Em breve vocÃª receberÃ¡ um novo teste.
Fique atento ao seu email.

Equipe ValidaPlay`
)}">
ðŸ“± ${t.whatsapp || "-"}
</a>
</div>

<div class="info">Tipo de celular: ${t.tipoCelular || "-"}</div>
<div class="info">Modelo: ${t.modelo || "-"}</div>
<div class="info">VersÃ£o: ${t.versao || "-"}</div>

<div class="info">Status:
  <strong class="status-${status}">
    ${status}
  </strong>
</div>

<div style="margin-top:10px;">

  ${status === "pendente" ? `
    <button class="btn-success" onclick="atualizarStatus('testadores','${id}','aprovado')">Aprovar</button>
    <button class="btn-secondary" onclick="atualizarStatus('testadores','${id}','rejeitado')">Rejeitar</button>
  ` : ''}

  ${status === "aprovado" ? `
    <button class="btn-warning" onclick="atualizarStatus('testadores','${id}','bloqueado')">Bloquear</button>
  ` : ''}

  ${status === "bloqueado" ? `
    <button class="btn-success" onclick="atualizarStatus('testadores','${id}','aprovado')">Reativar</button>
  ` : ''}

  <button class="btn-danger" onclick="excluirRegistro('testadores','${id}')">Excluir</button>

</div>

`;

        lista.appendChild(div);
    });
}

async function criarMissoes(appId){

  

 try {

  const appRef = doc(db,"solicitacoes",appId);
  const appSnap = await getDoc(appRef);

  if(!appSnap.exists()){
    alert("Aplicativo nÃ£o encontrado.");
    return;
  }

  const quantidade = appSnap.data().quantidade || 12;

  if(appSnap.data().missoesCriadas){
    alert("MissÃµes jÃ¡ foram criadas para este app.");
    return;
  }

  const confirmar = confirm(`Criar ${quantidade} missÃµes para este app?`);
  if(!confirmar) return;

  // ðŸ”Ž Buscar testadores aprovados
  const testadoresSnap = await getDocs(
    query(collection(db, "testadores"), orderBy("criadoEm","desc"))
  );

  const testadoresAprovados = testadoresSnap.docs
    .filter(doc => doc.data().status === "aprovado");

  // ðŸ”Ž Buscar missÃµes ativas (somente em andamento)
  const missoesSnap = await getDocs(
    query(collection(db,"missoes"), where("status","==","em_andamento"))
  );

  const missoesAtivas = missoesSnap.docs;

  // ðŸ”¢ Contar missÃµes por testador
  const contadorMissoes = {};

  missoesAtivas.forEach(m => {
    const tId = m.data().testadorId;
    contadorMissoes[tId] = (contadorMissoes[tId] || 0) + 1;
  });

  // ðŸŽ¯ Ordenar por quem tem menos missÃµes
  const ordenados = testadoresAprovados.sort((a,b) => {
    const aCount = contadorMissoes[a.id] || 0;
    const bCount = contadorMissoes[b.id] || 0;
    return aCount - bCount;
  });

  // ðŸŽ¯ Selecionar respeitando limite mÃ¡ximo de 3 missÃµes simultÃ¢neas
  const selecionados = [];

  for(const t of ordenados){
    const totalAtivas = contadorMissoes[t.id] || 0;

    if(totalAtivas < 3){
      selecionados.push(t);
    }

    if(selecionados.length === quantidade) break;
  }

  if(selecionados.length < quantidade){
    alert("NÃ£o hÃ¡ testadores suficientes disponÃ­veis.");
    return;
  }

  // ðŸš€ Criar missÃµes
  for(const testadorDoc of selecionados){

    await addDoc(collection(db,"missoes"),{
      appId: appId,
      testadorId: testadorDoc.id,
      status: "em_andamento",
      diaAtual: 1,
      totalDias: 14,
      dataInicio: new Date(),
      dataFim: new Date(Date.now() + 14*24*60*60*1000),
      criadoEm: new Date()
    });

  }

  await updateDoc(doc(db,"solicitacoes",appId),{
    missoesCriadas: true,
    dataInicioValidacao: new Date()
  });

  alert("MissÃµes criadas com sucesso!");
  carregarSolicitacoes();

} catch(error){
  console.error(error);
  alert("Erro ao criar missÃµes.");
}

}
window.criarMissoes = criarMissoes;

window.verDetalhes = function(id){
  window.location.href = "admin-detalhes.html?id=" + id;
}
</script>


</body>
</html>

