<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>HistÃ³rico de Apps - ValidaPlay</title>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#0f172a;
    color:white;
}

header{
    background:#020617;
    padding:20px;
    text-align:center;
    border-bottom:1px solid #1e293b;
}

h1{
    color:#38bdf8;
}

.container{
    padding:20px;
}

.card{
    background:#020617;
    border:1px solid #1e293b;
    border-radius:10px;
    padding:15px;
    margin-bottom:15px;
}

.nome{
    font-size:18px;
    color:#38bdf8;
    font-weight:bold;
}

.info{
    color:#cbd5e1;
    margin-top:4px;
}

button{
    margin-top:10px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    color:white;
    cursor:pointer;
    margin-right:5px;
}

.btn-detalhe{ background:#38bdf8; }
.btn-reativar{ background:#22c55e; }
.btn-voltar{ background:#ef4444; }
</style>
</head>

<body>

<header>
  <h1>HistÃ³rico de Apps Arquivados</h1>
</header>

<div class="container">

<button class="btn-voltar" onclick="window.location.href='admin.html'">
â¬… Voltar ao Painel
</button>

<div id="listaHistorico">Carregando...</div>

</div>

<script type="module">

import { db } from "./firebase.js";
import { 
  collection, 
  getDocs, 
  query, 
  orderBy, 
  where, 
  updateDoc, 
  doc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const lista = document.getElementById("listaHistorico");

async function carregarHistorico(){

    lista.innerHTML = "";

    // ðŸ”¥ Busca todos ordenados
    const q = query(
        collection(db,"solicitacoes"),
        orderBy("criadoEm","desc")
    );

    const snap = await getDocs(q);

    let encontrou = false;

    for(const docSnap of snap.docs){

        const s = docSnap.data();
        const id = docSnap.id;

        // ðŸ”¥ Mostrar apenas arquivados
        if(s.arquivado !== true) continue;

        encontrou = true;

        const dataArquivado = s.dataArquivado
            ? new Date(s.dataArquivado.seconds * 1000).toLocaleDateString()
            : "â€”";

        // ðŸ”¥ Contar testadores que concluÃ­ram
        const qMissoes = query(
            collection(db,"missoes"),
            where("appId","==", id),
            where("status","==","concluida")
        );

        const snapMissoes = await getDocs(qMissoes);

        const testadoresUnicos = new Set();

        snapMissoes.forEach(m=>{
            testadoresUnicos.add(m.data().testadorId);
        });

        const quantidadeReal = testadoresUnicos.size;

        const div = document.createElement("div");
        div.className="card";

        div.innerHTML = `
            <div class="nome">${s.nomeApp || "Sem nome"}</div>
            <div class="info">Arquivado em: ${dataArquivado}</div>
            <div class="info">Testadores que concluÃ­ram: ${quantidadeReal}</div>
            <div class="info">Status Final: ConcluÃ­do</div>

            <div style="margin-top:10px;">
                <button class="btn-detalhe"
                    onclick="verDetalhes('${id}')">
                    ðŸ”Ž Detalhes
                </button>

                <button class="btn-reativar"
                    onclick="reativarApp('${id}')">
                    â™» Reativar
                </button>
            </div>
        `;

        lista.appendChild(div);
    }

    if(!encontrou){
        lista.innerHTML = "<p>Nenhum app arquivado ainda.</p>";
    }
}

/* ðŸ”Ž DETALHES */
window.verDetalhes = function(id){
    window.location.href = "admin-detalhes.html?id=" + id;
}

/* â™» REATIVAR */
window.reativarApp = async function(id){

    const confirmar = confirm("Deseja reativar este app?");
    if(!confirmar) return;

    await updateDoc(doc(db,"solicitacoes",id),{
        arquivado:false,
        dataArquivado:null,
        status:"em_validacao"
    });

    alert("App reativado com sucesso!");

    window.location.href = "admin.html";
}

carregarHistorico();

</script>

</body>
</html>